@if (isOpen) {
  <div class="modal-overlay" (click)="onClose()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2>Добави фактура</h2>
        <button class="close-button" (click)="onClose()" type="button">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
            <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
          </svg>
        </button>
      </div>
      
      <div class="modal-body">
        <form (ngSubmit)="onSubmit()" #invoiceForm="ngForm">
          <!-- Company Selection -->
          <div class="form-section">
            <h3>Информация за компанията</h3>
            <div class="form-group">
              <label for="client">Клиент:</label>
              <select 
                id="client" 
                name="client" 
                [(ngModel)]="selectedClientId" 
                required
                class="form-select"
              >
                @for (client of customers; track client.id) {
                  <option [value]="client.id">{{ client.name }}</option>
                }
              </select>
            </div>

            <div class="form-group">
              <label for="supplier">Доставчик:</label>
              <select 
                id="supplier" 
                name="supplier" 
                [(ngModel)]="selectedSupplierId" 
                required
                class="form-select"
                [class.auto-selected]="suppliers.length === 1"
              >
                @for (supplier of suppliers; track supplier.id) {
                  <option [value]="supplier.id">{{ supplier.name }}</option>
                }
              </select>
            </div>
          </div>

          <!-- Items Section -->
          <div class="form-section">
            <div class="section-header">
              <h3>Артикули</h3>
              <button type="button" class="btn btn-add" (click)="addItem()">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/>
                </svg>
                Добави артикул
              </button>
            </div>

            @if (items.length === 0) {
              <div class="no-items">
                <p>Няма добавени артикули</p>
              </div>
            } @else {
              <div class="items-list">
                @for (item of items; track item.id; let i = $index) {
                  <div class="item-row">
                    <div class="item-field">
                      <label>Име на артикула</label>
                      <input 
                        type="text" 
                        [(ngModel)]="item.name" 
                        name="itemName{{i}}"
                        required
                        class="form-input"
                        placeholder="Въведете име на артикула"
                      >
                    </div>

                    <div class="item-field">
                      <label>Брой</label>
                      <input 
                        type="number" 
                        [(ngModel)]="item.quantity" 
                        name="itemQuantity{{i}}"
                        required
                        min="1"
                        class="form-input"
                        placeholder="1"
                      >
                    </div>

                    <div class="item-field">
                      <label>Единична цена</label>
                      <input 
                        type="number" 
                        [(ngModel)]="item.unitPrice" 
                        name="itemUnitPrice{{i}}"
                        required
                        min="0"
                        step="0.01"
                        class="form-input"
                        placeholder="0.00"
                      >
                    </div>

                    <div class="item-field">
                      <label>Отстъпка (%)</label>
                      <input 
                        type="number" 
                        [(ngModel)]="item.discount" 
                        name="itemDiscount{{i}}"
                        min="0"
                        max="100"
                        step="0.01"
                        class="form-input"
                        placeholder="0"
                      >
                    </div>

                    <div class="item-actions">
                      <button 
                        type="button" 
                        class="btn btn-remove" 
                        (click)="removeItem(i)"
                        title="Премахни артикул"
                      >
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                          <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
                        </svg>
                      </button>
                    </div>
                  </div>
                }
              </div>

              <div class="total-section">
                <div class="total-row">
                  <span class="total-label">Обща сума:</span>
                  <span class="total-amount">{{ calculateTotal }}</span>
                </div>
              </div>
            }
          </div>

<!-- VAT Exemption Section -->
<div class="form-section">
    <div class="form-group">
      <label for="vatExemption">Основание за не начисляване на ДДС:</label>
      <textarea 
        id="vatExemption"
        name="vatExemption"
        [(ngModel)]="reasonForSkippingVat"
        class="form-textarea"
        placeholder="Въведете основание за не начисляване на ДДС"
        rows="3"
      ></textarea>
    </div>
  </div>

          <div class="form-actions">
            <button type="button" class="btn btn-secondary" (click)="onClose()">
              Отказ
            </button>
            <button 
              type="submit" 
              class="btn btn-primary" 
              [disabled]="!invoiceForm.form.valid || loading || items.length === 0"
            >
              @if (loading) {
                Запазване...
              } @else {
                Запази фактура
              }
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
}
